<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Terrain Entra√Æneur</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      overflow: hidden;
    }

    #app {
      display: flex;
      height: 100vh;
      flex-direction: column;
    }

    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .left-panel {
      width: 300px;
      padding: 15px;
      background-color: #fff;
      overflow-y: auto;
      border-right: 1px solid #ccc;
      position: relative;
    }

    .canvas-container {
      flex: 1;
      position: relative;
      overflow: auto;
    }

    canvas {
      display: block;
      background: white;
      border: 2px solid #000;
      cursor: pointer;
      margin: 0 auto;
      max-width: 100%;
      height: auto;
    }

    .players-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 5px;
    }

    .player-item {
      display: flex;
      align-items: center;
      padding: 8px;
      margin-bottom: 5px;
      background: #eef;
      border-radius: 6px;
    }

    .player-label {
      display: flex;
      align-items: center;
      flex-grow: 1;
      cursor: pointer;
      padding: 5px;
    }

    .player-item:hover {
      background: #ddf;
    }

    .player-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
      background-color: #eee;
      border: 2px solid transparent;
    }

    .player-name {
      flex: 1;
      margin: 0 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-left: auto;
    }

    .status-online {
      background: #28a745;
    }

    .status-offline {
      background: #dc3545;
    }

    .info-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      margin-left: 10px;
      color: #666;
    }

    .info-btn:hover {
      color: #333;
    }

    input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }

    button {
      margin-top: 5px;
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      transition: all 0.2s;
    }

    button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .carte-joueur {
      margin-top: 15px;
      background: #fff;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
    }

    .audio-control-card {
      position: absolute;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 180px;
    }

    .audio-control-card h4 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 14px;
      white-space: nowrap;
    }

    .audio-control-buttons {
      display: flex;
      gap: 10px;
    }

    .audio-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      border: none;
      outline: none;
      transition: all 0.2s;
    }

    .audio-btn:hover {
      transform: scale(1.1);
    }

    .start-audio {
      background: #28a745;
      color: white;
    }

    .stop-audio {
      background: #dc3545;
      color: white;
    }

    .terrain-selector {
      margin-bottom: 15px;
      padding: 8px;
      width: 100%;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .form-group {
      margin-bottom: 10px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .form-actions {
      margin-top: 15px;
      display: flex;
      justify-content: space-between;
    }

    .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      color: #999;
    }

    .close-btn:hover {
      color: #333;
    }

    .multi-select-btn {
      background: #9c27b0;
      margin-top: 10px;
      width: 100%;
      font-weight: bold;
    }

    .stop-all-btn {
      background: #dc3545;
      margin-top: 10px;
      width: 100%;
      font-weight: bold;
      color: white;
    }

    .stop-all-btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .entraineurs-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    .entraineurs-list {
      max-height: 150px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .entraineur-item {
      padding: 8px;
      margin: 5px 0;
      background: #f5f5f5;
      border-radius: 4px;
      display: flex;
      align-items: center;
    }

    .entraineur-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #007bff;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-weight: bold;
    }

    .entraineur-name {
      flex: 1;
    }

    .entraineur-status {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #28a745;
    }

    .entraineur-status.offline {
      background: #dc3545;
    }

    .match-info {
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .match-name {
      font-weight: bold;
      margin-bottom: 5px;
      color: #007bff;
    }

    .logout-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #dc3545;
      z-index: 1000;
    }

    @media (max-width: 768px) {
      #app {
        height: auto;
        min-height: 100vh;
      }
      
      .main-content {
        flex-direction: column;
      }
      
      .left-panel {
        width: 100%;
        height: auto;
        max-height: 40vh;
        border-right: none;
        border-bottom: 1px solid #ccc;
      }
      
      .canvas-container {
        width: 100%;
        height: 60vh;
      }
      
      canvas {
        width: 100%;
        height: 100%;
        max-height: 60vh;
        object-fit: contain;
      }

      .logout-btn {
        position: fixed;
        top: 5px;
        right: 5px;
        padding: 5px 8px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
<!-- Ic√¥ne de profil -->
<div style="position: absolute; top: 10px; left: 10px;">
  <img 
    :src="entraineurAvatar" 
    @click="ouvrirFiche" 
    style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid #007bff;"
    title="Voir/√©diter mon profil"
  />
</div>
<button class="logout-btn" style="top: 50px;" @click="retourAuxMatchs">Retour aux matchs</button>
    <button class="logout-btn" @click="logout">D√©connexion</button>

    <div class="main-content">
      <div class="left-panel">
        <div class="match-info" v-if="currentMatch">
          <div class="match-name">{{ currentMatch.name }}</div>
          <div>Entra√Æneurs: {{ currentMatch.entraineurs.join(', ') }}</div>
        </div>

        <h3>Type de Terrain</h3>
        <select v-model="terrainChoisi" @change="changerTerrain" class="terrain-selector">
          <option value="foot">Football</option>
          <option value="basket">Basket</option>
        </select>

        <h3>Joueurs connect√©s</h3>
        <div class="players-list">
          <div v-for="joueur in joueursUniques" 
               :key="joueur.id" 
               class="player-item">
            <input type="checkbox" 
                   :id="'player-'+joueur.id"
                   v-model="selectedPlayers"
                   :value="joueur"
                   @click.stop>
            <label :for="'player-'+joueur.id" class="player-label">
              <img :src="joueur.avatar" class="player-avatar">
              <span class="player-name">{{ joueur.name }}</span>
              <span class="status-indicator" :class="'status-' + joueur.status"></span>
            </label>
            <button @click.stop="afficherCarteJoueur(joueur)" class="info-btn">‚ÑπÔ∏è</button>
          </div>
        </div>

        <button @click="demarrerAudioMulti" 
                class="multi-select-btn"
                :disabled="!selectedPlayers.length">
          üé§ Envoyer audio ({{ selectedPlayers.length }})
        </button>

        <button @click="arreterAudioPourTous"
                class="stop-all-btn"
                :disabled="!streamingEnCours">
          ‚èπÔ∏è Arr√™ter tout l'audio
        </button>

        <div v-if="carteVisible && joueurSelectionne" class="carte-joueur">
          <button class="close-btn" @click="fermerCartes">√ó</button>
          <div class="avatar-container">
            <img :src="joueurSelectionne.avatar" class="player-avatar">
            <h4>{{ joueurSelectionne.name }}</h4>
          </div>
          <p><strong>Position:</strong> ({{ joueurSelectionne.x.toFixed(0) }}, {{ joueurSelectionne.y.toFixed(0) }})</p>
          <button @click="ajouterJoueur(joueurSelectionne)">Ajouter au terrain</button>
          <button @click="afficherFormulaireModification()">Modifier</button>
          <button @click="supprimerJoueur(joueurSelectionne)" style="background:red;">Supprimer</button>
        </div>

        <div v-if="showModificationForm" class="carte-joueur">
          <button class="close-btn" @click="fermerCartes">√ó</button>
          <h4>Modifier Joueur</h4>
          <form @submit.prevent="validerModification">
            <div class="form-group">
              <label>Nom:</label>
              <input type="text" v-model="formModification.name" required>
            </div>
            <div class="form-group">
              <label>Position X:</label>
              <input type="number" v-model.number="formModification.x" required>
            </div>
            <div class="form-group">
              <label>Position Y:</label>
              <input type="number" v-model.number="formModification.y" required>
            </div>
            <div class="form-group">
              <label>Photo (URL):</label>
              <input type="text" v-model="formModification.avatar" placeholder="https://...">
            </div>
            <div class="form-actions">
              <button type="button" @click="annulerModification">Annuler</button>
              <button type="submit" style="background: #28a745;">Valider</button>
            </div>
          </form>
        </div>

        <div class="entraineurs-section" v-if="otherEntraineurs.length > 0">
          <h3>Autres entra√Æneurs</h3>
          <div class="entraineurs-list">
            <div v-for="entraineur in otherEntraineurs" :key="entraineur.id" class="entraineur-item">
              <div class="entraineur-avatar">{{ entraineur.name.charAt(0) }}</div>
              <div class="entraineur-name">{{ entraineur.name }}</div>
              <div class="entraineur-status" :class="{ offline: entraineur.status === 'offline' }"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="canvas-container">
        <canvas ref="canvas" width="1000" height="600"></canvas>
        
        <div v-if="audioControlVisible" class="audio-control-card" 
             :style="{ top: audioControlPos.y + 'px', left: audioControlPos.x + 'px' }">
          <button class="close-btn" @click="fermerCartes">√ó</button>
          <h4>Contr√¥le audio - {{ joueurSelectionne?.name }}</h4>
          <div class="audio-control-buttons">
            <button class="audio-btn start-audio" @click="demarrerAudio" :disabled="streamingEnCours">
              ‚ñ∂Ô∏è
            </button>
            <button class="audio-btn stop-audio" @click="arreterAudio" :disabled="!streamingEnCours">
              ‚èπÔ∏è
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const socket = io('http://localhost:4000');

    new Vue({
      el: "#app",
      data: {
        terrainChoisi: 'foot',
        canvas: null,
        ctx: null,
        canvasWidth: 1000,
        canvasHeight: 600,
        joueursConnectes: [],
        joueursSurTerrain: [],
        selectedPlayers: [],
        joueurSelectionne: null,
        joueurEnCoursDrag: null,
        offsetX: 0,
        offsetY: 0,
        carteVisible: false,
        audioControlVisible: false,
        audioControlPos: { x: 0, y: 0 },
        showModificationForm: false,
        formModification: {
          name: '',
          x: 0,
          y: 0,
          avatar: 'https://via.placeholder.com/50'
        },
        streamingEnCours: false,
entraineurAvatar: localStorage.getItem('entraineurAvatar') || 'https://via.placeholder.com/40',

        currentMatch: null,
        otherEntraineurs: [],
        entraineurName: localStorage.getItem('entraineurName') || 'Entra√Æneur',
        rolesFoot: [
          { name: "Gardien", x: 80, y: 300 },
          { name: "D√©fenseur", x: 200, y: 100 },
          { name: "D√©fenseur", x: 200, y: 200 },
          { name: "D√©fenseur", x: 200, y: 400 },
          { name: "D√©fenseur", x: 200, y: 500 },
          { name: "Milieu", x: 400, y: 100 },
          { name: "Milieu", x: 400, y: 300 },
          { name: "Milieu", x: 400, y: 500 },
          { name: "Attaquant", x: 650, y: 200 },
          { name: "Attaquant", x: 650, y: 400 },
          { name: "Attaquant", x: 800, y: 300 }
        ],
        rolesBasket: [
          { name: "Meneur", x: 200, y: 300 },
          { name: "Arri√®re", x: 350, y: 200 },
          { name: "Arri√®re", x: 350, y: 400 },
          { name: "Ailier", x: 600, y: 150 },
          { name: "Pivot", x: 700, y: 300 }
        ]
      },
      computed: {
        joueursUniques() {
          const uniqueNames = new Set();
          return this.joueursConnectes.filter(joueur => {
            if (!uniqueNames.has(joueur.name)) {
              uniqueNames.add(joueur.name);
              return true;
            }
            return false;
          });
        }
      },
      mounted() {
        this.initCanvas();
        this.setupEventListeners();
        this.chargerJoueurs();
        this.dessinerTerrain();

        const currentMatchId = localStorage.getItem('currentMatch');
        if (currentMatchId) {
          socket.emit('join-match', currentMatchId);
        }

        socket.on('players-list', (players) => {
          this.joueursConnectes = players.map(player => ({
            ...player,
            avatar: player.avatar || 'https://via.placeholder.com/50'
          }));
        });

        socket.on('stream-stopped', () => {
          this.streamingEnCours = false;
          this.audioControlVisible = false;
          this.dessinerTerrain();
        });
        socket.on('audio-rejected', (data) => {
  alert(data.reason || "Impossible de d√©marrer l'audio pour ce joueur.");
});


        socket.on('match-update', (match) => {
          this.currentMatch = {
            ...match,
            entraineurs: match.entraineurs.map(e => e.name)
          };
        });

        socket.on('entraineurs-list', (entraineurs) => {
          this.otherEntraineurs = entraineurs.filter(e => 
            e.currentMatch === localStorage.getItem('currentMatch') && 
            e.name !== this.entraineurName
          );
        });

        socket.on('joueurs-update', (joueurs) => {
          this.joueursSurTerrain = joueurs;
          this.dessinerTerrain();
        });

        window.addEventListener('resize', this.handleResize);

        // Synchroniser les joueurs toutes les 5 secondes
        setInterval(() => {
          if (this.currentMatch) {
            socket.emit('sync-joueurs', {
              matchId: localStorage.getItem('currentMatch'),
              joueurs: this.joueursSurTerrain
            });
          }
        }, 5000);
      },
      beforeDestroy() {
        window.removeEventListener('resize', this.handleResize);
      },
      methods: {
        logout() {
          localStorage.removeItem('entraineurName');
          localStorage.removeItem('entraineurPassword');
          localStorage.removeItem('currentMatch');
          window.location.href = '/';
        },
        initCanvas() {
          this.canvas = this.$refs.canvas;
          this.ctx = this.canvas.getContext('2d');
          this.adjustCanvasSize();
        },
        
        adjustCanvasSize() {
          const container = this.canvas.parentElement;
          const ratio = this.canvasWidth / this.canvasHeight;
          let width = container.clientWidth;
          let height = width / ratio;
          
          if (height > container.clientHeight) {
            height = container.clientHeight;
            width = height * ratio;
          }
          
          this.canvas.style.width = width + 'px';
          this.canvas.style.height = height + 'px';
        },
        
        handleResize() {
          this.adjustCanvasSize();
          this.dessinerTerrain();
        },
ouvrirFiche() {
  window.location.href = '/index.html';
},
retourAuxMatchs() {
  window.open('/match.html', '_blank');
},
        
        setupEventListeners() {
          this.canvas.addEventListener("mousedown", this.startDrag);
          this.canvas.addEventListener("mousemove", this.onDrag);
          this.canvas.addEventListener("mouseup", this.stopDrag);
          this.canvas.addEventListener("mouseleave", this.stopDrag);
          this.canvas.addEventListener("dblclick", this.selectionnerSurTerrain);
        },

        fermerCartes() {
          this.carteVisible = false;
          this.audioControlVisible = false;
          this.showModificationForm = false;
        },

        changerTerrain() {
          this.sauvegarderJoueurs();
          this.dessinerTerrain();
        },

        chargerJoueurs() {
          const savedPlayers = localStorage.getItem('joueursSurTerrain');
          const savedTerrain = localStorage.getItem('terrainChoisi');
          
          if (savedTerrain) {
            this.terrainChoisi = savedTerrain;
          }
          
          if (savedPlayers) {
            this.joueursSurTerrain = JSON.parse(savedPlayers).map(player => ({
              ...player,
              avatar: player.avatar || 'https://via.placeholder.com/50'
            }));
          }

          // Demander les joueurs synchronis√©s pour ce match
          if (localStorage.getItem('currentMatch')) {
            socket.emit('request-joueurs', localStorage.getItem('currentMatch'));
          }
        },

        sauvegarderJoueurs() {
          localStorage.setItem('joueursSurTerrain', JSON.stringify(this.joueursSurTerrain));
          localStorage.setItem('terrainChoisi', this.terrainChoisi);
          
          // Synchroniser avec les autres entra√Æneurs
          if (this.currentMatch) {
            socket.emit('sync-joueurs', {
              matchId: localStorage.getItem('currentMatch'),
              joueurs: this.joueursSurTerrain
            });
          }
        },

        dessinerTerrain() {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          
          if (this.terrainChoisi === 'foot') {
            this.dessinerTerrainFoot();
            this.dessinerRoles(this.rolesFoot);
          } else {
            this.dessinerTerrainBasket();
            this.dessinerRoles(this.rolesBasket);
          }
          
          this.joueursSurTerrain.forEach(j => this.dessinerJoueur(j));
        },

        dessinerRoles(roles) {
          roles.forEach(role => {
            this.ctx.fillStyle = "#a3d5ff";
            this.ctx.beginPath();
            this.ctx.arc(role.x, role.y, 18, 0, Math.PI * 2);
            this.ctx.fill();
            this.ctx.fillStyle = "#000";
            this.ctx.font = "12px Arial";
            this.ctx.textAlign = "center";
            this.ctx.fillText(role.name, role.x, role.y - 25);
          });
        },

        dessinerJoueur(joueur) {
          const ctx = this.ctx;
          
          if (this.streamingEnCours && this.joueurSelectionne?.name === joueur.name) {
            ctx.fillStyle = "#ff5722";
          } else if (this.selectedPlayers.some(j => j.name === joueur.name)) {
            ctx.fillStyle = "#9c27b0";
          } else {
            ctx.fillStyle = "#007bff";
          }
          
          ctx.beginPath();
          ctx.arc(joueur.x, joueur.y, 18, 0, Math.PI * 2);
          ctx.fill();
          
          ctx.fillStyle = "#fff";
          ctx.font = "12px Arial";
          ctx.textAlign = "center";
          ctx.fillText(joueur.name, joueur.x, joueur.y - 25);
          
          if (this.joueurSelectionne && this.joueurSelectionne.name === joueur.name) {
            ctx.strokeStyle = "#ff0";
            ctx.lineWidth = 3;
            ctx.stroke();
          }
        },

        afficherCarteJoueur(joueur) {
          const joueurSurTerrain = this.joueursSurTerrain.find(j => j.name === joueur.name);
          
          if (joueurSurTerrain) {
            this.joueurSelectionne = joueurSurTerrain;
          } else {
            this.joueurSelectionne = {
              ...joueur,
              x: this.terrainChoisi === 'foot' ? 500 : 400,
              y: 300,
              avatar: joueur.avatar || 'https://via.placeholder.com/50'
            };
          }
          
          this.carteVisible = true;
          this.audioControlVisible = false;
          this.showModificationForm = false;
        },

        selectionnerSurTerrain(e) {
          const rect = this.canvas.getBoundingClientRect();
          const scaleX = this.canvas.width / rect.width;
          const scaleY = this.canvas.height / rect.height;
          const x = (e.clientX - rect.left) * scaleX;
          const y = (e.clientY - rect.top) * scaleY;
          
          const joueur = this.getJoueurSousCoord(x, y);
          if (joueur) {
            this.joueurSelectionne = joueur;
            this.carteVisible = true;
            this.audioControlVisible = true;
            this.showModificationForm = false;
            this.audioControlPos = { 
              x: e.clientX - 75, 
              y: e.clientY - 80 
            };
            this.dessinerTerrain();
          } else {
            this.audioControlVisible = false;
            this.carteVisible = false;
            this.showModificationForm = false;
          }
        },

        afficherFormulaireModification() {
          if (this.joueurSelectionne) {
            this.formModification = {
              name: this.joueurSelectionne.name,
              x: Math.round(this.joueurSelectionne.x),
              y: Math.round(this.joueurSelectionne.y),
              avatar: this.joueurSelectionne.avatar || 'https://via.placeholder.com/50'
            };
            this.showModificationForm = true;
          }
        },

        validerModification() {
          if (this.joueurSelectionne) {
            this.joueurSelectionne.name = this.formModification.name;
            this.joueurSelectionne.x = this.formModification.x;
            this.joueurSelectionne.y = this.formModification.y;
            this.joueurSelectionne.avatar = this.formModification.avatar;
            
            this.showModificationForm = false;
            this.sauvegarderJoueurs();
            this.dessinerTerrain();
          }
        },

        annulerModification() {
          this.showModificationForm = false;
        },

        ajouterJoueur(joueur) {
          if (!this.joueursSurTerrain.some(j => j.name === joueur.name)) {
            const positionInit = this.terrainChoisi === 'foot' 
              ? { x: 500, y: 300 } 
              : { x: 400, y: 300 };
            
            const nouveauJoueur = { 
              ...joueur,
              ...positionInit,
              avatar: joueur.avatar || 'https://via.placeholder.com/50'
            };
            
            this.joueursSurTerrain.push(nouveauJoueur);
            this.joueurSelectionne = nouveauJoueur;
            this.carteVisible = false;
            this.sauvegarderJoueurs();
            this.dessinerTerrain();
          }
        },

        supprimerJoueur(joueur) {
          this.joueursSurTerrain = this.joueursSurTerrain.filter(j => j.name !== joueur.name);
          this.selectedPlayers = this.selectedPlayers.filter(j => j.name !== joueur.name);
          this.joueurSelectionne = null;
          this.audioControlVisible = false;
          this.carteVisible = false;
          this.showModificationForm = false;
          this.sauvegarderJoueurs();
          this.dessinerTerrain();
        },

        getJoueurSousCoord(x, y) {
          return this.joueursSurTerrain.find(j =>
            Math.hypot(j.x - x, j.y - y) < 20
          );
        },

        startDrag(e) {
          const rect = this.canvas.getBoundingClientRect();
          const scaleX = this.canvas.width / rect.width;
          const scaleY = this.canvas.height / rect.height;
          const x = (e.clientX - rect.left) * scaleX;
          const y = (e.clientY - rect.top) * scaleY;
          
          const joueur = this.getJoueurSousCoord(x, y);
          if (joueur) {
            this.joueurEnCoursDrag = joueur;
            this.offsetX = x - joueur.x;
            this.offsetY = y - joueur.y;
            this.joueurSelectionne = joueur;
            e.preventDefault();
          }
        },

        onDrag(e) {
          if (this.joueurEnCoursDrag) {
            const rect = this.canvas.getBoundingClientRect();
            const scaleX = this.canvas.width / rect.width;
            const scaleY = this.canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            this.joueurEnCoursDrag.x = x - this.offsetX;
            this.joueurEnCoursDrag.y = y - this.offsetY;
            this.dessinerTerrain();
            e.preventDefault();
          }
        },

        stopDrag() {
          if (this.joueurEnCoursDrag) {
            this.sauvegarderJoueurs();
          }
          this.joueurEnCoursDrag = null;
        },

        demarrerAudio() {
          if (this.joueurSelectionne) {
            socket.emit('start-stream-to', this.joueurSelectionne.name);
            this.streamingEnCours = true;
            this.dessinerTerrain();
          }
        },

        demarrerAudioMulti() {
          if (this.selectedPlayers.length > 0) {
            const nomsJoueurs = this.selectedPlayers.map(j => j.name);
            socket.emit('start-stream-to', nomsJoueurs);
            this.streamingEnCours = true;
            this.dessinerTerrain();
          }
        },

        arreterAudio() {
          socket.emit('stop-audio-stream');
          this.streamingEnCours = false;
          this.audioControlVisible = false;
          this.dessinerTerrain();
        },

        arreterAudioPourTous() {
          socket.emit('stop-audio-stream');
          this.streamingEnCours = false;
          this.dessinerTerrain();
        },

        dessinerTerrainFoot() {
          const ctx = this.ctx;
          const w = this.canvas.width;
          const h = this.canvas.height;
          
          ctx.fillStyle = "#6ab150";
          ctx.fillRect(0, 0, w, h);
          
          ctx.strokeStyle = "#fff";
          ctx.lineWidth = 2;
          ctx.strokeRect(0, 0, w, h);
          
          ctx.beginPath();
          ctx.moveTo(w / 2, 0);
          ctx.lineTo(w / 2, h);
          ctx.stroke();
          
          ctx.beginPath();
          ctx.arc(w / 2, h / 2, 60, 0, Math.PI * 2);
          ctx.stroke();
          
          ctx.strokeRect(0, (h - 200) / 2, 100, 200);
          ctx.strokeRect(w - 100, (h - 200) / 2, 100, 200);
          
          ctx.strokeRect(0, (h - 50) / 2, 10, 50);
          ctx.strokeRect(w - 10, (h - 50) / 2, 10, 50);
        },

        dessinerTerrainBasket() {
          const ctx = this.ctx;
          const w = this.canvas.width;
          const h = this.canvas.height;
          
          ctx.fillStyle = "#f79c42";
          ctx.fillRect(0, 0, w, h);
          
          ctx.strokeStyle = "#fff";
          ctx.lineWidth = 2;
          
          ctx.beginPath();
          ctx.moveTo(w / 2, 0);
          ctx.lineTo(w / 2, h);
          ctx.stroke();
          
          ctx.beginPath();
          ctx.arc(w / 2, h / 2, 60, 0, Math.PI * 2);
          ctx.stroke();
          
          ctx.strokeRect(0, 0, 200, h);
          ctx.strokeRect(w - 200, 0, 200, h);
          
          ctx.beginPath();
          ctx.arc(180, h / 2, 20, 0, Math.PI * 2);
          ctx.stroke();
          
          ctx.beginPath();
          ctx.arc(w - 180, h / 2, 20, 0, Math.PI * 2);
          ctx.stroke();
          
          ctx.beginPath();
          ctx.arc(180, h / 2, 120, 0.25 * Math.PI, 0.75 * Math.PI, true);
          ctx.lineTo(180, h / 2 - 120);
          ctx.stroke();
          
          ctx.beginPath();
          ctx.arc(w - 180, h / 2, 120, 0.25 * Math.PI, 0.75 * Math.PI, false);
          ctx.lineTo(w - 180, h / 2 + 120);
          ctx.stroke();
        }
      }
    });
  </script>
</body>
</html>